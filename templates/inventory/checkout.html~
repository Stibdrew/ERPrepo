{% extends 'users/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Checkout</h2>

    <!-- Product Information -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">{{ product_request.product.name }}</h5>
            <p class="card-text"><strong>Price:</strong> <span class="formatted-price" data-price="{{ product_request.product.price }}">$ {{ product_request.product.price|floatformat:2 }}</span></p>
            <p class="card-text"><strong>SKU:</strong> {{ product_request.product.sku }}</p>
            <p class="card-text"><strong>Description:</strong> {{ product_request.product.description }}</p>
            <p class="card-text"><strong>Quantity Requested:</strong> {{ product_request.quantity_requested }}</p>
            <p class="card-text"><strong>Total Cost:</strong> <span class="formatted-total-cost" data-total-cost="{{ total_cost }}">$ {{ total_cost|floatformat:2 }}</span></p>
            <p class="card-text"><strong>Tax (0.1%):</strong> <span class="formatted-tax" data-tax="{{ tax }}">$ {{ tax|floatformat:2 }}</span></p>
            <p class="card-text"><strong>Shipping Fee:</strong> <span class="formatted-shipping-fee" data-shipping-fee="{{ shipping_fee }}">$ {{ shipping_fee|floatformat:2 }}</span></p>
            <p class="card-text"><strong>Total Cost with Tax and Shipping:</strong> <span class="formatted-total" data-total="{{ total_with_tax_and_shipping }}">$ {{ total_with_tax_and_shipping|floatformat:2 }}</span></p>
        </div>
    </div>

    <!-- Checkout Form -->
    {% if product_request.status == 'paid' %}
        <a href="{% url 'receipt' product_request.id %}" class="btn btn-success btn-block mt-3">View Receipt</a>
    {% else %}
        <form method="POST" action="{% url 'process_payment' product_request.id %}">
            {% csrf_token %}
            <!-- Shipping Address -->
            <div class="form-group">
                <label for="shipping_address">Shipping Address</label>
                <textarea id="shipping_address" name="shipping_address" class="form-control" rows="3" required placeholder="Enter your shipping address"></textarea>
            </div>

            <!-- Debit Card Number -->
            <div class="form-group">
                <label for="card_number">Debit Card Number</label>
                <input type="text" id="card_number" name="card_number" class="form-control" maxlength="16" required placeholder="Enter your debit card number">
            </div>

            <!-- Expiry Date -->
            <div class="form-group">
                <label for="expiry_date">Card Expiry Date</label>
                <input type="month" id="expiry_date" name="expiry_date" class="form-control" required>
            </div>

            <!-- CVV -->
            <div class="form-group">
                <label for="cvv">CVV</label>
                <input type="text" id="cvv" name="cvv" class="form-control" maxlength="3" required placeholder="3-digit CVV">
            </div>

            <!-- Unit of Money (USD) -->
            <div class="form-group">
                <label for="currency">Unit of Money</label>
                <input type="text" id="currency" name="currency" class="form-control" value="USD" readonly>
            </div>

            <!-- Terms and Agreement -->
            <div class="form-group">
                <input type="checkbox" id="terms" name="terms" required>
                <label for="terms">I agree to the terms and conditions</label>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary btn-block mt-3">Proceed with Payment</button>
        </form>
    {% endif %}
</div>

<script>
    // Function to format numbers with commas
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // Format all prices on the page
    document.querySelectorAll('.formatted-price, .formatted-total-cost, .formatted-tax, .formatted-shipping-fee, .formatted-total').forEach(element => {
        const price = parseFloat(element.dataset.price || element.dataset.totalCost || element.dataset.tax || element.dataset.shippingFee || element.dataset.total);
        if (!isNaN(price)) {
            element.innerText = '$' + formatNumber(price.toFixed(2)); // Add dollar sign here
        }
    });
</script>
{% endblock %}
